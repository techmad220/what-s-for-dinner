name: Security & Quality Gates

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  lint:
    name: Code Quality (Ruff)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install dependencies
        run: pip install ruff
      - name: Run Ruff linter
        run: ruff check dinner_app/ tests/

  security-scan:
    name: Security Scan (Bandit)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install dependencies
        run: pip install bandit
      - name: Run Bandit security scan
        run: bandit -r dinner_app/ -ll --exclude tests

  secrets-scan:
    name: Secrets Detection
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install detect-secrets
        run: pip install detect-secrets
      - name: Run secrets scan
        run: detect-secrets scan --all-files --exclude-files '\.git/.*' --exclude-files '.*\.json$'

  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install dependencies
        run: |
          pip install pytest hypothesis
          pip install -r requirements.txt
      - name: Run unit tests
        run: |
          PYTHONPATH=. pytest tests/ -v --ignore=tests/test_kitchen_sink_fuzz.py --ignore=tests/test_fuzzing_aggressive.py

  fuzz-quick:
    name: Quick Fuzz Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install dependencies
        run: |
          pip install pytest hypothesis
          pip install -r requirements.txt
      - name: Run quick fuzzing
        run: |
          PYTHONPATH=. pytest tests/test_fuzzing.py -v --hypothesis-seed=0

  fuzz-aggressive:
    name: Aggressive Fuzz Tests (Security Gate)
    runs-on: ubuntu-latest
    timeout-minutes: 120
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install dependencies
        run: |
          pip install pytest hypothesis
          pip install -r requirements.txt
      - name: Run aggressive fuzzing
        run: |
          PYTHONPATH=. pytest tests/test_fuzzing_aggressive.py -v --hypothesis-seed=0

  kitchen-sink-full:
    name: Kitchen Sink Full Fuzzing (4hr Security Gate)
    runs-on: ubuntu-latest
    timeout-minutes: 300
    if: github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install dependencies
        run: |
          pip install pytest hypothesis
          pip install -r requirements.txt
      - name: Run kitchen sink fuzzing
        run: |
          PYTHONPATH=. pytest tests/test_kitchen_sink_fuzz.py -v --hypothesis-seed=0
      - name: Check for vulnerabilities found
        run: |
          if [ -f tests/vulnerabilities_found.log ]; then
            echo "VULNERABILITIES FOUND - FAILING BUILD"
            cat tests/vulnerabilities_found.log
            exit 1
          fi
